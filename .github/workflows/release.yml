name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.1.0). Leave empty to auto-increment minor version.'
        required: false
        type: string

env:
  RUST_VERSION: "1.91"

jobs:
  create-release:
    name: Create Release
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # Full history for tag detection

      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          version: 2025.11.11

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Tag push - extract from ref
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
            echo "TAG_NAME=v$VERSION" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ inputs.version }}" ]; then
            # Manual trigger with version
            VERSION="${{ inputs.version }}"
            echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
            echo "TAG_NAME=v$VERSION" >> "$GITHUB_OUTPUT"
          else
            # Auto-increment minor version
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            LATEST_VERSION="${LATEST_TAG#v}"

            # Parse version (semver: MAJOR.MINOR.PATCH)
            IFS='.' read -r MAJOR MINOR _ <<< "$LATEST_VERSION"

            # Increment minor, reset patch
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="$MAJOR.$NEW_MINOR.0"

            echo "VERSION=$NEW_VERSION" >> "$GITHUB_OUTPUT"
            echo "TAG_NAME=v$NEW_VERSION" >> "$GITHUB_OUTPUT"
            echo "Previous: $LATEST_TAG â†’ New: v$NEW_VERSION"
          fi

      - name: Create and push tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.TAG_NAME }}" -m "Release ${{ steps.version.outputs.TAG_NAME }}"
          git push origin "${{ steps.version.outputs.TAG_NAME }}"

      - name: Cache cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: mise exec -- cargo build --release
        env:
          GGML_NO_ACCELERATE: 1
          WHISPER_NO_AVX: 1
          WHISPER_NO_AVX2: 1
          WHISPER_NO_FMA: 1
          CFLAGS: "-march=armv8-a"
          CXXFLAGS: "-march=armv8-a"

      - name: Create .app bundle
        run: ./scripts/create-app-bundle.sh

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: ./scripts/create-dmg.sh ${{ steps.version.outputs.VERSION }}

      - name: Calculate checksums
        run: |
          cd target/release
          shasum -a 256 WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg > WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg.sha256
          cat WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg.sha256

      - name: Create release notes
        id: release_notes
        run: |
          # Get previous tag for changelog
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ steps.version.outputs.TAG_NAME }}^ 2>/dev/null || echo "")

          # Start release notes
          cat > release_notes.md <<'EOF'
          # WhisperHotkey v${{ steps.version.outputs.VERSION }}

          macOS voice-to-text app using local Whisper. Hold hotkey, speak, release â†’ text inserted at cursor.

          EOF

          # Generate What's New section if previous tag exists
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## What's New" >> release_notes.md
            echo "" >> release_notes.md

            # Get commits since previous tag, grouped by type
            FEATURES=$(git log --pretty=format:"%s" "${PREVIOUS_TAG}..${{ steps.version.outputs.TAG_NAME }}" | grep "^feat" || true)
            FIXES=$(git log --pretty=format:"%s" "${PREVIOUS_TAG}..${{ steps.version.outputs.TAG_NAME }}" | grep "^fix" || true)
            OTHERS=$(git log --pretty=format:"%s" "${PREVIOUS_TAG}..${{ steps.version.outputs.TAG_NAME }}" | grep -v "^feat" | grep -v "^fix" || true)

            # Features
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features" >> release_notes.md
              echo "" >> release_notes.md
              echo "$FEATURES" | while read -r line; do
                # Extract message (remove feat: or feat(scope):)
                MSG="${line#feat: }"
                MSG="${MSG#feat\(*\): }"
                echo "- $MSG" >> release_notes.md
              done
              echo "" >> release_notes.md
            fi

            # Bug fixes
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes" >> release_notes.md
              echo "" >> release_notes.md
              echo "$FIXES" | while read -r line; do
                # Extract message (remove fix: or fix(scope):)
                MSG="${line#fix: }"
                MSG="${MSG#fix\(*\): }"
                echo "- $MSG" >> release_notes.md
              done
              echo "" >> release_notes.md
            fi

            # Other changes
            if [ -n "$OTHERS" ]; then
              echo "### ðŸ”§ Other Changes" >> release_notes.md
              echo "" >> release_notes.md
              echo "$OTHERS" | while read -r line; do
                # Extract message (remove type: prefix)
                MSG="${line#*: }"
                echo "- $MSG" >> release_notes.md
              done
              echo "" >> release_notes.md
            fi

            echo "**Full Changelog**: https://github.com/Automaat/whisper-hotkey/compare/${PREVIOUS_TAG}...${{ steps.version.outputs.TAG_NAME }}" >> release_notes.md
            echo "" >> release_notes.md
          fi

          # Append installation instructions
          cat >> release_notes.md <<'EOF'

          ## Installation

          1. **Download**: `WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg`
          2. **Open DMG**: Double-click to mount
          3. **Install**: Drag `WhisperHotkey.app` to `Applications` folder
          4. **Bypass Gatekeeper** (first time only - required because app is ad-hoc signed, not notarized with Apple Developer certificate):
             - Right-click `WhisperHotkey.app` in Applications
             - Select "Open"
             - Click "Open" in security dialog

             Or via Terminal:
             ```bash
             xattr -d com.apple.quarantine /Applications/WhisperHotkey.app
             open /Applications/WhisperHotkey.app
             ```
          5. **Permissions**: Grant Microphone + Accessibility when prompted
          6. **First run**: Downloads Whisper model (~466MB)

          ## Usage

          - **Default hotkey**: `Ctrl+Option+Z`
          - Press and hold â†’ speak â†’ release
          - Text appears at cursor

          ## Configuration

          - Edit: `~/.whisper-hotkey/config.toml`
          - Change hotkey, model, performance settings
          - Restart app after changes

          ## Auto-Start

          See [documentation](https://github.com/Automaat/whisper-hotkey#auto-start-at-login) for LaunchAgent setup.

          ## Requirements

          - macOS 11.0+ (Big Sur or later)
          - Apple Silicon (M1/M2/M3) or Intel
          - ~500MB disk space (~466MB for model)

          ## Verification

          ```bash
          shasum -a 256 -c WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg.sha256
          ```

          ## Support

          - [Documentation](https://github.com/Automaat/whisper-hotkey)
          - [Issues](https://github.com/Automaat/whisper-hotkey/issues)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@7b4da11513bf3f43f9999e90eabced41ab8bb048 # v2.2.0
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          files: |
            target/release/WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg
            target/release/WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg.sha256
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get SHA256 for Homebrew
        id: sha256
        run: |
          SHA256=$(cat "target/release/WhisperHotkey-${{ steps.version.outputs.VERSION }}.dmg.sha256" | awk '{print $1}')
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "âœ“ SHA256: $SHA256"

      - name: Trigger Homebrew Tap Update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: Automaat/homebrew-whisper-hotkey
          event-type: update-cask
          client-payload: '{"version": "${{ steps.version.outputs.VERSION }}", "sha256": "${{ steps.sha256.outputs.sha256 }}"}'
